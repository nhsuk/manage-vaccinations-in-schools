<% content_for :before_main do %>
  <%= govuk_back_link(href: @back_link_path) %>
<% end %>

<% content_for :page_title, "Which batch did you use for the #{@programme.name_in_sentence} vaccination?" %>

<%= form_with model: @draft_vaccination_record, url: wizard_path, method: :put do |f| %>
  <%= f.govuk_error_summary %>

<% if @draft_vaccination_record.national_reporting_user_and_record? %>

    <span class="nhsuk-caption-l"><%= @patient.full_name %></span>
    <%= h1 "Which vaccine and batch did you use?" %>

  <%= f.govuk_radio_buttons_fieldset :vaccine_id,
                                     legend: { text: "Vaccine", size: "m" } do %>
    <% @vaccines.each do |vaccine| %>
      <%= f.govuk_radio_button :vaccine_id, vaccine.id, label: { text: vaccine.nivs_name } %>
    <% end %>
  <% end %>

  <%= f.govuk_text_field :batch_name,
                         label: { text: "Batch number", size: "m" }, width: 10, class: "nhsuk-input--code" %>

  <%= f.govuk_date_field :batch_expiry,
                         legend: { text: "Batch expiry date", size: "m" },
                         hint: { text: "For example, 27 10 2025" } %>
<% else %>
  <%= f.govuk_radio_buttons_fieldset :batch_id,
                                     caption: { text: @patient.full_name, size: "l" },
                                     legend: { size: "l", tag: "h1", text: "Which batch did you use?" } do %>
    <% @batches.find_each do |batch| %>
      <% label = proc do %>
        <span class="app-u-code"><%= batch.name %></span>
        (<%= batch.vaccine.brand %>)
      <% end %>

      <% hint = proc do %>
        <% if (expiry = batch.expiry) %>
          Expires <%= expiry.to_fs(:long) %>
        <% end %>
      <% end %>

      <%= f.govuk_radio_button :batch_id, batch.id, label:, hint: do %>
        <% if @programme.can_save_to_todays_batch? && !@draft_vaccination_record.editing? %>
          <%= f.govuk_check_box :todays_batch,
                                batch.id,
                                label: { text: "Default to this batch for this session" } %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
<% end %>

  <%= f.govuk_submit "Continue" %>
<% end %>
