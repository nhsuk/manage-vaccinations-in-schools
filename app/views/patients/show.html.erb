<% content_for :before_main do %>
  <%= render AppBreadcrumbComponent.new(items: [
                                          { text: t("dashboard.index.title"), href: dashboard_path },
                                          { text: t("patients.index.title"), href: patients_path },
                                        ]) %>
<% end %>

<%= render "patients/header" %>

<%= render AppPatientSecondaryNavigationComponent.new(patient: @patient, current_user: current_user) %>

<% vaccinations_card = capture do %>
  <%= render AppCardComponent.new(section: true) do |card| %>
    <% card.with_heading { "Vaccinations" } %>
    <%= render AppPatientVaccinationTableComponent.new(
          @patient, academic_year: AcademicYear.current, show_caption: false,
        ) %>
  <% end %>
<% end %>

<% if current_team.has_national_reporting_access? %>
  <%= vaccinations_card %>
<% end %>

<%= render AppPatientCardComponent.new(
      @patient,
      current_team:,
      show_parents: !current_team.has_national_reporting_access?,
      heading_actions: [
        if policy(@patient).edit?
          {
            text: "Edit child record",
            href: edit_patient_path(@patient),
          }
        end,
        if Patient::ArchivePolicy.new(current_user, @patient).new? && @patient.not_archived?(team: current_team)
          {
            text: "Archive child record",
            href: new_patient_archive_path(@patient),
          }
        end,
      ].compact,
    ) %>

<% unless current_team.has_national_reporting_access? %>
  <%= render AppCardComponent.new(section: true) do |card| %>
    <%= render AppPatientProgrammesTableComponent.new(
          @patient,
          programmes: current_user.programmes,
          current_team:,
        ) %>
  <% end %>

  <%= render AppCardComponent.new(section: true) do |card| %>
    <% card.with_heading { "Sessions" } %>
    <%= render AppPatientSessionTableComponent.new(@patient, current_team:) %>

    <% unless @in_generic_clinic %>
      <%= govuk_button_to "Invite to community clinic", invite_to_clinic_patient_path(@patient), secondary: true %>
    <% end %>
  <% end %>

  <%= vaccinations_card %>
<% end %>
