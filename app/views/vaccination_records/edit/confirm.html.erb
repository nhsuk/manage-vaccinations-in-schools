<% content_for :before_main do %>
  <%= render AppBacklinkComponent.new(
        href: @vaccination_record.recorded? ? programme_vaccination_record_path(@vaccination_record) : vaccinations_back_link_path,
        name: "vaccination page",
      ) %>
<% end %>

<% if @vaccination_record.recorded? %>
  <% page_title = "Edit vaccination record" %>
  <%= h1 page_title do %>
    <span class="nhsuk-caption-l">
      <%= @patient.full_name %>
    </span>
    <%= page_title %>
  <% end %>
<% else %>
  <%= h1 "Check and confirm" %>
<% end %>

<% if @vaccination_record.administered? %>
  <%= render AppCardComponent.new do |card| %>
    <% card.with_heading { "Vaccination details" } %>
    <%= render AppVaccinationRecordSummaryComponent.new(
          @vaccination_record,
          current_user:,
          change_links: {
            administered_at: wizard_path("date-and-time"),
            batch: wizard_path(:batch),
            delivery_method: wizard_path("delivery-site"),
            delivery_site: wizard_path("delivery-site"),
            location: @vaccination_record.wizard_steps.include?(:location) ? wizard_path(:location) : nil,
            outcome: @vaccination_record.recorded? ? nil : session_patient_path(
              @session,
              @patient,
              section: "vaccinations",
              tab: "vaccinate",
            ),
          },
          show_notes: false,
        ) %>
  <% end %>
<% else %>
  <%= render AppWarningCalloutComponent.new(heading: "Vaccination was not given") do %>
    <%= render AppVaccinationRecordSummaryComponent.new(
          @vaccination_record,
          current_user:,
          change_links: {
            administered_at: wizard_path("date-and-time"),
            outcome: @vaccination_record.recorded? ? nil : session_patient_path(
              @session,
              @patient,
              section: "vaccinations",
              tab: "vaccinate",
            ),
          },
          show_notes: false,
        ) %>
  <% end %>
<% end %>

<% if @vaccination_record.recorded? %>
  <%= govuk_button_to "Continue", wizard_path, method: :put, prevent_double_click: true %>
<% else %>
  <%= form_with model: @vaccination_record,
                url: wizard_path,
                method: :put do |f| %>
    <% content_for(:before_content) { f.govuk_error_summary } %>

    <div class="nhsuk-card">
      <div class="nhsuk-card__content">
        <%= f.govuk_text_area :notes,
                              label: {
                                text: "Add notes",
                                size: "m",
                                class: "nhsuk-u-margin-bottom-3",
                              },
                              hint: {
                                text: "For example, if the child had a reaction to the vaccine",
                              },
                              rows: 5 %>
      </div>
    </div>

    <%= f.govuk_submit "Confirm" %>
  <% end %>
<% end %>
