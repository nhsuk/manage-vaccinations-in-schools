<% content_for :before_main do %>
  <%= render AppBacklinkComponent.new(
        href: new_programme_immunisation_import_path(@programme),
        name: @programme.name,
      ) %>
<% end %>

<% title = "Check and confirm" %>

<span class="nhsuk-caption-l"><%= @programme.name %></span>
<%= h1 title, page_title: "#{@programme.name} â€“ #{title}" %>

<% if @immunisation_import.exact_duplicate_record_count > 1 || @immunisation_import.changed_record_count > 1 ||
      @immunisation_import.not_administered_record_count > 1 %>
  <%= render AppWarningCalloutComponent.new(heading: "Uploaded records will differ from file") do %>
    <ul class="nhsuk-list nhsuk-list--bullet">
      <% if @immunisation_import.exact_duplicate_record_count > 1 %>
        <li>
          <%= @immunisation_import.exact_duplicate_record_count %> previously
          uploaded records were omitted
        </li>
      <% end %>

      <% if @immunisation_import.changed_record_count > 1 %>
        <li>
          <%= @immunisation_import.changed_record_count %> previously uploaded records were updated
        </li>
      <% end %>

      <% if @immunisation_import.not_administered_record_count > 1 %>
        <li>
          <%= @immunisation_import.not_administered_record_count %> records for
          children who were not vaccinated were omitted
        </li>
      <% end %>
    </ul>
  <% end %>
<% end %>

<%= govuk_button_to "Upload records", programme_immunisation_import_path(
      @programme,
      @immunisation_import
    ), method: :put %>

<% if @vaccination_records_with_pending_changes.present? %>
  <div class="nhsuk-table__panel-with-heading-tab">
    <h3 class="nhsuk-table__heading-tab">
      <%= pluralize(@vaccination_records_with_pending_changes.count,
                    "duplicate record") %>
      <%= @vaccination_records_with_pending_changes.count == 1 ?
            "needs" : "need" %> review
    </h3>
    <%= govuk_table(html_attributes: {
                      class: "nhsuk-table-responsive",
                    }) do |table| %>
      <% table.with_head do |head| %>
        <% head.with_row do |row| %>
          <% row.with_cell(text: "Child record") %>
          <% row.with_cell(text: "Issue to review") %>
          <% row.with_cell(text: "Actions") %>
        <% end %>
      <% end %>

      <% table.with_body do |body| %>
        <% @vaccination_records_with_pending_changes.each do |vaccination_record| %>
          <% body.with_row do |row| %>
            <% row.with_cell do %>
              <span class="nhsuk-table-responsive__heading">Child record</span>
              <%= vaccination_record.patient.full_name %>
            <% end %>

            <% row.with_cell do %>
              <span class="nhsuk-table-responsive__heading">
                Issue to review
              </span>
              A field in a duplicate record does not match a previously uploaded
              record
            <% end %>

            <% row.with_cell do %>
              <span class="nhsuk-table-responsive__heading">Actions</span>
              <%= govuk_link_to programme_immunisation_import_duplicate_path(
                    @programme,
                    @immunisation_import,
                    vaccination_record
                  ) do %>
                Review
                <span class="nhsuk-u-visually-hidden">
                  <%= vaccination_record.patient.full_name %>
                </span>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  </div>
<% end %>

<%= render AppVaccinationRecordTableComponent.new(@vaccination_records,
                                                  new_records: true) %>
