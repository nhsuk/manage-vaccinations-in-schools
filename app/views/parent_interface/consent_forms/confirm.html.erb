<% content_for :before_main do %>
  <%= render AppBacklinkComponent.new(
        href: session_parent_interface_consent_form_edit_path(@session, @consent_form, :consent),
        name: "edit consent page",
      ) %>
<% end %>

<% change_link = Proc.new do |attr, params = {}|
     options = attr.in?(%i[consent reason]) ? {} : { skip_to_confirm: true }
     session_parent_interface_consent_form_edit_path(
       @session,
       @consent_form,
       attr.to_s.dasherize,
       options.merge(params)
     )
   end %>

<%= h1 "Check your answers and confirm" %>

<%= render AppCardComponent.new do |c| %>
  <% c.with_heading { t("consent_forms.confirm.consent_card_title.#{@consent_form.session.type.downcase}") } %>
  <%= govuk_summary_list classes: "app-summary-list--no-bottom-border" do |summary_list|
        summary_list.with_row do |row|
          row.with_key { "Do you agree?" }
          row.with_value {
            @consent_form.consent_given? ?
              t("consent_forms.confirm.i_agree.#{@consent_form.session.type.downcase}") :
              "No"
          }
          row.with_action(text: "Change",
                          href: change_link[:consent],
                          visually_hidden_text: "consent")
        end
      
        reason_notes = @consent_form.reason_notes.present? ? "<br>".html_safe + @consent_form.reason_notes : ""
        reason_for_refusal_text = @consent_form.human_enum_name(:reason) + reason_notes
      
        if @consent_form.consent_refused?
          summary_list.with_row do |row|
            row.with_key { "Reason" }
            row.with_value { reason_for_refusal_text.html_safe }
            row.with_action(text: "Change",
                            href: change_link[:reason],
                            visually_hidden_text: "reason for refusal")
          end
      
          if !@consent_form.contact_injection.nil?
            summary_list.with_row do |row|
              row.with_key { "Alternative option" }
              row.with_value {
                @consent_form.contact_injection? ?
                  "Someone can contact me about an injection" :
                  "No"
              }
              row.with_action(text: "Change",
                              href: change_link[:injection],
                              visually_hidden_text: "alternative option")
            end
          end
        end
      end %>
<% end %>

<%= render AppCardComponent.new do |c| %>
  <% c.with_heading { "About your child" } %>
  <%= govuk_summary_list classes: "app-summary-list--no-bottom-border" do |summary_list|
        summary_list.with_row do |row|
          row.with_key { "Child’s name" }
          row.with_value { @consent_form.full_name }
          row.with_action(text: "Change",
                          href: change_link[:name],
                          visually_hidden_text: "child’s name")
        end
      
        if @consent_form.use_common_name
          summary_list.with_row do |row|
            row.with_key { "Also known as" }
            row.with_value { @consent_form.common_name }
            row.with_action(text: "Change",
                            href: change_link[:name],
                            visually_hidden_text: "common name")
          end
        end
      
        summary_list.with_row do |row|
          row.with_key { "Date of birth" }
          row.with_value { @consent_form.date_of_birth.to_fs(:long) }
          row.with_action(
            text: "Change",
            href: change_link[:date_of_birth],
            visually_hidden_text: "date of birth",
          )
        end
      
        if @consent_form.consent_given?
          summary_list.with_row do |row|
            row.with_key { "Address" }
            row.with_value { format_address(@consent_form) }
            row.with_action(
              text: "Change",
              href: change_link[:address],
              visually_hidden_text: "address",
            )
          end
        end
      
        summary_list.with_row do |row|
          row.with_key { "School" }
          row.with_value { @consent_form.session.location.name }
          row.with_action(
            text: "Change",
            href: change_link[:school],
            visually_hidden_text: "school",
          )
        end
      
        if @consent_form.gp_response_yes?
          summary_list.with_row do |row|
            row.with_key { "GP Surgery" }
            row.with_value { @consent_form.gp_name }
            row.with_action(
              text: "Change",
              href: change_link[:gp],
              visually_hidden_text: "GP",
            )
          end
        end
      
        if @consent_form.gp_response_no? || @consent_form.gp_response_dont_know?
          summary_list.with_row do |row|
            row.with_key { "Registered with a GP" }
            row.with_value { @consent_form.gp_response_no? ? "No" : "I don’t know" }
            row.with_action(
              text: "Change",
              href: change_link[:gp],
              visually_hidden_text: "GP",
            )
          end
        end
      end %>
<% end %>

<%= render AppCardComponent.new do |c| %>
  <% c.with_heading { "About you" } %>
  <%= govuk_summary_list classes: "app-summary-list--no-bottom-border" do |summary_list|
        summary_list.with_row do |row|
          row.with_key { "Your name" }
          row.with_value { @consent_form.parent_name }
          row.with_action(text: "Change",
                          href: change_link[:parent],
                          visually_hidden_text: "your name")
        end
      
        summary_list.with_row do |row|
          row.with_key { "Relationship" }
          row.with_value { @consent_form.parent_relationship_label }
          row.with_action(text: "Change",
                          href: change_link[:parent],
                          visually_hidden_text: "your relationship")
        end
      
        summary_list.with_row do |row|
          row.with_key { "Email address" }
          row.with_value { @consent_form.parent_email }
          row.with_action(text: "Change",
                          href: change_link[:parent],
                          visually_hidden_text: "your email")
        end
      
        if @consent_form.parent_phone.present?
          summary_list.with_row do |row|
            row.with_key { "Phone number" }
            row.with_value { @consent_form.parent_phone }
            row.with_action(text: "Change",
                            href: change_link[:parent],
                            visually_hidden_text: "your phone")
          end
      
          if @consent_form.parent_contact_method_type.present?
            summary_list.with_row do |row|
              row.with_key { "Phone contact method" }
              row.with_value { @consent_form.parent_contact_method_description }
              row.with_action(text: "Change",
                              href: change_link[:contact_method],
                              visually_hidden_text: "your phone contact method")
            end
          end
        else
          summary_list.with_row do |row|
            row.with_key { "Phone number" }
            row.with_value { "Not provided" }
            row.with_action(text: "Change",
                            href: change_link[:parent],
                            visually_hidden_text: "your phone")
          end
        end
      end %>
<% end %>

<% if @consent_form.consent_given? %>
  <%= render AppCardComponent.new do |c| %>
    <% c.with_heading { "Health questions" } %>
    <%= govuk_summary_list classes: "app-summary-list--full-width" do |summary_list|
          @consent_form.each_health_answer do |ha|
            summary_list.with_row do |row|
              row.with_key { ha.question }
              row.with_value { health_answer_response(ha) }
              row.with_action(text: "Change",
                              href: change_link[:health_question, question_number: ha.id],
                              visually_hidden_text: "your answer to health question #{ha.id + 1}")
            end
          end
        end %>
  <% end %>
<% end %>

<%= govuk_button_to "Confirm",
                    url_for(action: :record),
                    method: :put,
                    prevent_double_click: true %>
