# frozen_string_literal: true

class DataMigration::SchoolRemovalForBlmkAndNw
  def self.perform
    new.perform
  end

  def self.warn_about_incorrect_state
    new.warn_about_incorrect_state
  end

  def perform
    ActiveRecord::Base.transaction do
      remove_existing_schools!(
        subteams: [bedfordshire_luton_and_milton_keynes, norfolk_and_waveney]
      )
      add_correct_schools!(
        subteam: bedfordshire_luton_and_milton_keynes,
        schools: correct_blkm_schools
      )
      add_correct_schools!(
        subteam: norfolk_and_waveney,
        schools: correct_n_and_w_schools
      )
      remove_orphan_sessions(
        teams: [
          bedfordshire_luton_and_milton_keynes.team,
          norfolk_and_waveney.team
        ]
      )

      if incorrect_state_warnings.any?
        raise "Script failed to achieve desired outcome:\n#{warnings.join("\n")}"
      end
    end
    nil
  end

  def warn_about_incorrect_state
    incorrect_state_warnings.each { |warning| warn warning }
  end

  private

  def incorrect_state_warnings
    warnings_for_wrong_schools_assigned(
      subteam: bedfordshire_luton_and_milton_keynes,
      desired_schools: correct_blkm_schools
    ) +
      warnings_for_wrong_schools_assigned(
        subteam: norfolk_and_waveney,
        desired_schools: correct_n_and_w_schools
      )
  end

  def remove_existing_schools!(subteams:)
    Location.school.where(subteam: subteams).update_all(subteam_id: nil)
  end

  def add_correct_schools!(subteam:, schools:)
    schools.each do |location|
      if location.subteam
        warn "URN #{location.urn} previously belonged to #{location.subteam.name}"
      end

      location.update!(subteam:)
      location.sessions.update_all(team_id: subteam.team.id)
    end
  end

  def remove_orphan_sessions(teams:)
    Session
      .where(team: teams)
      .to_a
      .select { it.location.subteam.nil? }
      .each do |session|
        if session.session_dates.any?(&:has_been_attended?)
          warn "Session #{session.id} has been attended, refusing to delete session"
        else
          session.destroy!
        end
      end
  end

  def warnings_for_schools_with_no_sessions(subteams:)
    subteams.flat_map do |subteam|
      subteam.schools.filter_map do |school|
        if school.sessions.empty?
          "No sessions for #{school.name} (URN #{school.urn})"
        end
      end
    end
  end

  def warnings_for_wrong_schools_assigned(subteam:, desired_schools:)
    warnings = []
    actual_schools = Location.school.where(subteam: subteam)
    (desired_schools - actual_schools).each do |school|
      warnings << "Subteam #{subteam.name} should have #{school.name} (URN #{school.urn}), but it  is missing"
    end
    (actual_schools - desired_schools).each do |school|
      warnings << "Subteam #{subteam.name} should not have #{school.name} (URN #{school.urn}), but it does"
    end
    warnings
  end

  def bedfordshire_luton_and_milton_keynes
    @bedfordshire_luton_and_milton_keynes ||=
      Subteam.find_by(
        name:
          "Bedfordshire, Luton and Milton Keynes School Age Immunisation Service"
      )
  end

  def norfolk_and_waveney
    @norfolk_and_waveney ||=
      Subteam.find_by(
        name: "Norfolk and Waveney School Age Immunisation Service"
      )
  end

  def correct_blkm_schools
    @correct_blkm_schools ||=
      [
        109_428,
        109_429,
        109_432,
        109_433,
        109_436,
        109_440,
        109_442,
        109_443,
        109_446,
        109_451,
        109_452,
        109_456,
        109_457,
        109_458,
        109_459,
        109_460,
        109_462,
        109_463,
        109_464,
        109_466,
        109_468,
        109_469,
        109_471,
        109_472,
        109_473,
        109_475,
        109_476,
        109_479,
        109_480,
        109_481,
        109_482,
        109_483,
        109_484,
        109_486,
        109_487,
        109_489,
        109_492,
        109_493,
        109_495,
        109_502,
        109_503,
        109_504,
        109_506,
        109_507,
        109_508,
        109_509,
        109_512,
        109_513,
        109_515,
        109_521,
        109_522,
        109_523,
        109_527,
        109_534,
        109_546,
        109_548,
        109_552,
        109_553,
        109_556,
        109_556,
        109_558,
        109_560,
        109_562,
        109_564,
        109_567,
        109_571,
        109_572,
        109_572,
        109_574,
        109_575,
        109_578,
        109_579,
        109_581,
        109_583,
        109_584,
        109_585,
        109_588,
        109_590,
        109_591,
        109_591,
        109_594,
        109_595,
        109_599,
        109_603,
        109_604,
        109_605,
        109_609,
        109_610,
        109_611,
        109_613,
        109_615,
        109_617,
        109_618,
        109_619,
        109_622,
        109_624,
        109_626,
        109_627,
        109_628,
        109_635,
        109_664,
        109_666,
        109_669,
        109_686,
        109_689,
        109_690,
        109_694,
        109_702,
        109_703,
        109_707,
        109_715,
        109_717,
        109_718,
        109_720,
        109_726,
        109_727,
        109_728,
        109_739,
        109_742,
        109_743,
        109_743,
        109_744,
        109_745,
        109_745,
        109_746,
        110_213,
        110_230,
        110_231,
        110_240,
        110_252,
        110_256,
        110_257,
        110_327,
        110_330,
        110_345,
        110_355,
        110_363,
        110_365,
        110_366,
        110_367,
        110_368,
        110_369,
        110_372,
        110_375,
        110_379,
        110_380,
        110_381,
        110_382,
        110_385,
        110_394,
        110_395,
        110_399,
        110_400,
        110_401,
        110_404,
        110_405,
        110_406,
        110_407,
        110_408,
        110_443,
        110_476,
        110_481,
        110_482,
        110_483,
        110_517,
        110_532,
        110_565,
        110_567,
        110_575,
        110_580,
        110_584,
        110_584,
        110_584,
        110_587,
        110_587,
        110_592,
        128_768,
        130_597,
        130_600,
        130_609,
        131_089,
        131_348,
        131_397,
        131_718,
        131_850,
        131_851,
        132_236,
        132_246,
        132_786,
        132_787,
        133_596,
        134_072,
        134_073,
        134_155,
        134_289,
        134_318,
        134_423,
        134_525,
        134_701,
        134_805,
        134_807,
        135_021,
        135_270,
        135_271,
        135_271,
        135_337,
        135_338,
        135_539,
        135_665,
        135_946,
        135_987,
        135_990,
        135_996,
        136_085,
        136_122,
        136_153,
        136_275,
        136_319,
        136_345,
        136_454,
        136_454,
        136_468,
        136_470,
        136_471,
        136_539,
        136_552,
        136_559,
        136_560,
        136_651,
        136_660,
        136_713,
        136_730,
        136_766,
        136_792,
        136_829,
        136_842,
        136_842,
        136_844,
        136_853,
        137_052,
        137_052,
        137_061,
        137_169,
        137_249,
        137_290,
        137_324,
        137_462,
        137_469,
        137_522,
        137_555,
        137_632,
        137_636,
        137_679,
        137_756,
        137_778,
        137_853,
        137_886,
        137_896,
        137_904,
        137_941,
        137_947,
        137_947,
        137_948,
        138_003,
        138_021,
        138_022,
        138_027,
        138_067,
        138_181,
        138_209,
        138_228,
        138_253,
        138_439,
        138_440,
        138_469,
        138_558,
        138_571,
        138_605,
        138_714,
        138_715,
        138_844,
        138_933,
        138_938,
        138_939,
        139_057,
        139_160,
        139_219,
        139_320,
        139_372,
        139_374,
        139_411,
        139_411,
        139_449,
        139_473,
        139_510,
        139_515,
        139_517,
        139_519,
        139_522,
        139_523,
        139_547,
        139_612,
        139_705,
        139_782,
        139_798,
        139_861,
        139_990,
        140_075,
        140_228,
        140_252,
        140_276,
        140_281,
        140_286,
        140_734,
        140_835,
        141_271,
        141_520,
        142_036,
        142_263,
        142_264,
        142_310,
        142_322,
        142_387,
        142_672,
        142_907,
        143_084,
        143_263,
        143_265,
        143_561,
        143_766,
        143_770,
        143_850,
        143_926,
        144_010,
        144_039,
        144_137,
        144_311,
        144_312,
        144_342,
        144_357,
        144_424,
        144_424,
        144_458,
        144_528,
        144_545,
        144_546,
        144_595,
        144_746,
        145_043,
        145_063,
        145_219,
        145_324,
        145_325,
        145_426,
        145_427,
        145_736,
        145_805,
        145_861,
        145_872,
        146_269,
        146_462,
        146_685,
        146_714,
        146_751,
        147_081,
        147_112,
        147_154,
        147_183,
        147_269,
        147_376,
        147_376,
        147_380,
        147_381,
        147_690,
        147_803,
        147_804,
        147_860,
        147_891,
        147_891,
        147_994,
        148_104,
        148_193,
        148_227,
        148_229,
        148_234,
        148_297,
        148_334,
        148_411,
        148_420,
        148_551,
        148_640,
        148_692,
        148_835,
        148_982,
        149_106,
        149_107,
        149_208,
        149_324,
        149_404,
        149_460,
        149_470,
        149_542,
        149_662,
        150_145,
        150_335,
        150_413,
        150_474,
        150_593,
        150_595,
        150_629,
        150_792,
        150_796,
        151_041,
        151_042,
        151_047,
        151_125,
        151_126,
        151_151,
        151_210,
        151_218,
        151_293,
        151_368,
        151_371,
        151_372,
        151_526,
        151_796,
        151_840,
        151_866,
        152_290,
        152_290
      ].map { |urn| Location.school.find_by_urn_and_site!(urn) }
  end

  def correct_n_and_w_schools
    @correct_n_and_w_schools ||=
      [
        138_758,
        135_066,
        145_089,
        121_250,
        140_534,
        151_655,
        121_229,
        148_360,
        134_978,
        121_164,
        148_346,
        138_274,
        121_231,
        142_759,
        146_063,
        120_909,
        136_998,
        148_572,
        141_331,
        148_541,
        145_529,
        135_904,
        141_269,
        140_364,
        149_693,
        149_866,
        137_431,
        144_316,
        137_092,
        145_196,
        148_859,
        137_134,
        139_099,
        139_572,
        150_265,
        145_501,
        145_776,
        121_256,
        135_859,
        121_223,
        142_883,
        121_222,
        121_257,
        121_264,
        138_039,
        140_188,
        142_059,
        139_311,
        140_121,
        134_440,
        138_877,
        140_815,
        148_826,
        136_202,
        121_225,
        121_224,
        146_237,
        144_018,
        147_505,
        141_268,
        130_764,
        121_241,
        121_242,
        129_511,
        137_913,
        138_779,
        146_144,
        134_455,
        139_535,
        139_403,
        136_187,
        136_186,
        146_909,
        135_250,
        150_112,
        138_829,
        151_217,
        142_058,
        121_246,
        137_621,
        121_258,
        121_254,
        139_896,
        137_055,
        143_520,
        136_515,
        144_359,
        121_252,
        140_557,
        141_395,
        149_151,
        139_487,
        148_618,
        121_261,
        130_763,
        148_395,
        136_821,
        149_197,
        149_909,
        138_918,
        135_650,
        121_262,
        139_665,
        145_960,
        136_204,
        144_769,
        121_245,
        143_278,
        121_237,
        150_354,
        140_753,
        141_086,
        146_431,
        120_888,
        137_949,
        136_481,
        137_461
      ].map { |urn| Location.school.find_by_urn_and_site!(urn) }
  end
end
