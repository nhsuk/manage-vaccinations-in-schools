<h3 class="nhsuk-heading-m">Triage</h3>

<%= render AppCardComponent.new(feature: true) do |card| %>
  <% card.with_heading(level: 4, colour:) { heading } %>

  <% if triage_status_value == :not_required %>
    <p>No triage is needed for <%= patient.full_name %>.</p>

    <div class="nhsuk-button-group">
      <% if helpers.policy(Triage).new? %>
        <%= govuk_button_link_to "Update triage outcome",
                                 new_session_patient_programme_triages_path(session, patient, programme),
                                 secondary: true %>
      <% end %>
    </div>
  <% elsif latest_triage.nil? || latest_triage.keep_in_triage? %>
    <% if helpers.policy(Triage).new? %>
      <p>You need to decide if <%= patient.full_name %> is safe to vaccinate.</p>

      <% if triage_status_generator.vaccination_history_requires_triage? %>
        <p>Incomplete vaccination history for <%= programme.name_in_sentence %>. Check if the child needs another dose.</p>
      <% end %>

      <%= render AppTriageFormComponent.new(
            triage_form,
            url: session_patient_programme_triages_path(session, patient, programme),
          ) %>
    <% else %>
      <p>A nurse needs to decide if <%= patient.full_name %> is safe to vaccinate.</p>
    <% end %>
  <% elsif latest_triage %>
    <% if (summary = triage_summary(latest_triage)) %>
      <p><%= summary %></p>
    <% end %>

    <div class="nhsuk-button-group">
      <% if helpers.policy(Triage).new? %>
        <%= govuk_button_link_to "Update triage outcome",
                                 new_session_patient_programme_triages_path(session, patient, programme),
                                 secondary: true %>
      <% end %>
    </div>
  <% end %>

  <%= render AppTriageTableComponent.new(patient:, session:, programme:) %>
<% end %>
