name: Build and push images
run-name: Build and push images for ${{ inputs.git-sha || github.sha }}

on:
  workflow_dispatch:
    inputs:
      git_sha:
        description: The FULL git commit sha to build the image from (optional).
        type: string
  workflow_call:
    inputs:
      git_sha:
        description: The git commit sha to build the image from.
        type: string

env:
  PUSH_IMAGE_TO_PRODUCTION: ${{ github.ref_name == 'main' }}
  git_ref: ${{ inputs.git_sha || github.sha }}

concurrency:
  group: build-and-push-image-${{ inputs.git_sha || github.sha }}

permissions: {}

jobs:
  check-image-presence:
    name: Check if images already exist
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        image_type: ["webapp", "ops"]
    permissions:
      id-token: write
    outputs:
      webapp-build-needed: ${{ steps.check-dev-image.outputs.webapp-build-needed || steps.check-prod-image.outputs.webapp-build-needed }}
      ops-build-needed: ${{ steps.check-dev-image.outputs.ops-build-needed || steps.check-prod-image.outputs.ops-build-needed }}
    steps:
      - name: Configure AWS Dev Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::393416225559:role/GithubDeployMavisAndInfrastructure
          aws-region: eu-west-2
      - name: Check if dev image exists
        id: check-dev-image
        run: |
          if aws ecr describe-images --repository-name mavis/${{ matrix.image_type }} --image-ids imageTag=$git_ref > /dev/null 2>&1; then
            echo "Dev image with given tag already exists"
          else
            echo "Dev image does not exist. Build needed"
            echo "${{ matrix.image_type }}-build-needed=true" >> $GITHUB_OUTPUT
          fi
      - name: Configure AWS Production credentials
        if: env.PUSH_IMAGE_TO_PRODUCTION == 'true'
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::820242920762:role/GithubDeployMavisAndInfrastructure
          aws-region: eu-west-2
      - name: Check if production image exists
        if: env.PUSH_IMAGE_TO_PRODUCTION == 'true'
        id: check-prod-image
        run: |
          if aws ecr describe-images --repository-name mavis/${{ matrix.image_type }} --image-ids imageTag=$git_ref > /dev/null 2>&1; then
            echo "Production image with given tag already exists"
          else
            echo "Production image does not exist. Build needed"
            echo "${{ matrix.image_type }}-build-needed=true" >> $GITHUB_OUTPUT
          fi
  define-matrix:
    name: Determine AWS roles to push the image
    runs-on: ubuntu-latest
    needs: check-image-presence
    outputs:
      aws-roles: ${{ steps.determine-aws-roles.outputs.aws-roles }}
    steps:
      - name: Set aws roles
        id: determine-aws-roles
        run: |
          if [ $PUSH_IMAGE_TO_PRODUCTION = 'true' ]; then
            echo 'aws-roles=["arn:aws:iam::393416225559:role/GithubDeployMavisAndInfrastructure", "arn:aws:iam::820242920762:role/GithubDeployMavisAndInfrastructure"]' >> $GITHUB_OUTPUT
          else
            echo 'aws-roles=["arn:aws:iam::393416225559:role/GithubDeployMavisAndInfrastructure"]' >> $GITHUB_OUTPUT
          fi
  build:
    needs: check-image-presence
    if: needs.check-image-presence.outputs.webapp-build-needed == 'true' || needs.check-image-presence.outputs.ops-build-needed  == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ env.git_ref }}
      - name: Write build SHA
        run: git rev-parse HEAD > public/sha
      - name: Build webapp docker image
        run: docker build -t "mavis-webapp:latest" .
      - name: Save web image
        run: docker save -o image.tar mavis-webapp:latest
      - name: Upload web image
        uses: actions/upload-artifact@v5
        with:
          name: webapp-image
          path: image.tar
      - name: Build ops docker image
        run: docker build -f ops.Dockerfile -t "mavis-ops:latest" .
      - name: Save ops image
        run: docker save -o image.tar mavis-ops:latest
      - name: Upload ops image
        uses: actions/upload-artifact@v5
        with:
          name: ops-image
          path: image.tar
  push:
    runs-on: ubuntu-latest
    needs: [build, define-matrix]
    permissions:
      id-token: write
    strategy:
      matrix:
        aws-role: ${{ fromJSON(needs.define-matrix.outputs.aws-roles) }}
        image_type: ["webapp", "ops"]
    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v6
        with:
          name: ${{ matrix.image_type }}-image
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ matrix.aws-role }}
          aws-region: eu-west-2
      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Load Docker image
        run: docker load -i image.tar
      - name: Tag Docker image
        run: docker tag mavis-${{ matrix.image_type }}:latest "${{ steps.login-ecr.outputs.registry }}/mavis/${{ matrix.image_type }}":"$git_ref"
      - name: Push Docker image
        run: docker push "${{ steps.login-ecr.outputs.registry }}/mavis/${{ matrix.image_type }}":"$git_ref"
