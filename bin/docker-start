#!/usr/bin/env bash

BIN_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

# Extract ENV_VARS into set of variables and export them to the shell
if [ -n "$ENV_VARS" ]; then
  IFS=',' read -ra ADDR <<< "$ENV_VARS"
  for i in "${ADDR[@]}"; do
    if [[ "$i" == *"="* ]]; then
      export "${i?}"
      echo "Exported: $i"
    fi
  done
fi

if [ "$SERVER_TYPE" == "web" ]; then
  echo "Starting web server..."
  exec "$BIN_DIR"/thrust "$BIN_DIR"/rails server
elif [ "$SERVER_TYPE" == "sidekiq" ]; then
  echo "Starting sidekiq server..."
  exec "$BIN_DIR"/sidekiq
elif [ "$SERVER_TYPE" == "none" ]; then
  echo "No server started"
  exec tail -f /dev/null  # Keep container running
else
  echo "SERVER_TYPE variable: '$SERVER_TYPE' unknown. Allowed values: web, sidekiq, none"
  exit 1
fi
