
# NHS Message Exchange for Social Care and Health (MESH) integration

## Initial setup

To connect with NHS MESH in the integration or production environments, you'll
need a mailbox allocated and a TLS certificate generated for you. These are
different in each environment. To get these you'll need:

- an ODS code for your organisation
- to have begun onboarding with the [NHS Digital onboarding
  service](https://onboarding.prod.api.platform.nhs.uk/Products); your use case
  for MESH should be accepted before you start integrating with it

For development, you can run the [MESH Sandbox](https://github.com/NHSDigital/mesh-sandbox)
locally without either of these, but SSL verification should disabled by setting
`Settings.mesh.disable_ssl_verification` to true. For new environments the
steps below will need to be followed.

### Getting a MESH Mailbox

Request a MESH mailbox using the link [Apply for a MESH mailbox - NHS England
Digital](https://digital.nhs.uk/services/message-exchange-for-social-care-and-health-mesh/messaging-exchange-for-social-care-and-health-apply-for-a-mailbox),
follow the instructions there. You should receive the mailbox name, id and
password. You'll also need the shared secret for environment, if you don't have
it already you can email itoc.supportdesk@nhs.net to get it.

The password and shared secret need to be added to the app secrets, and the
mailbox identifier to the environment's settings YAML. See the section on
configuring the app for more detail.

### TLS Certificate

#### Generating the private key and certificate request

Generate a private key in the file `private_key.pem`, enter an appropriate
passphrase when prompted:

```shell
openssl genpkey -algorithm RSA -out private_key.pem -aes256
```

Decide on a common name using the mailbox id received and our ODS code:
`mailboxid.n1g3b.api.mesh-client.nhs.uk`. Some of the NHS docs suggest using
`server001` instead of the `mailboxid` or something similar, but this patterns
fits Mavis better where we'll have one TLS certificate per environment.

Then use the common name when generating the CSR (make sure to add your common
name below):

```shell
openssl req -new -key private_key.pem -out request.csr -subj "/CN=mailboxid.n1g3b.api.mesh-client.nhs.uk"
```

Email the `request.csr` file that's generated to ITOC support with a request to
generate the TLS certificate. Include the application name, mailbox id,
environment and common name from above.

### Adding the certificates to the app

Save the root CA and sub CA from [Integration environments - NHS England
Digital](https://digital.nhs.uk/services/path-to-live-environments/integration-environment#rootca-and-subca-certificates)
into the bundle file `config/mesh_ca_bundle.pem` ensuring the root CA comes
first.

The certificates, the private key and it's passphrase will need to be added to
the app secrets. The app is configured to pull these out. See the section on
configuring Mavis for more detail.

## Configuring Mavis

The connection to MESH is configured using Settings (see the YAML files in
`config/settings/*`). 

- **base_url**: Environment-specific URL for MESH
- **mailbox**: _Secret_ - Mavis' MESH mailbox, requested from ITOC support
- **password**: _Secret_ - Password for Mavis' mailbox, comes with the mailbox from ITOC support
- **dps_mailbox**: Destination mailbox for DPS
- **shared_key**: _Secret_ - Shared key, also supplied by ITOC support
- **private_key**: _Secret_ - Mavis' key used to generate the certificate
- **private_key_passphrase**: _Secret_ - Passphrase for private key
- **certificate**: _Secret_ - Certificate generated by ITOC support
- **disable_ssl_verification**: Set to `true` when connecting to a locally hosted sandbox instance

Settings marked as _Secret_ need to be added to the app secrets. `copilot` is
configured to pull these values from there, and you can add values with to it
with `copilot secret init`.

## Jobs

This MESH connection is controlled by the feature flag `mesh_jobs` which needs
to be enabled for the related jobs to connect to MESH, otherwise they will fail
silently.

- **MESHValidateMailboxJob** - This job validates the mailbox with MESH letting
  it know that it is active and the service using it is running. It should run
  every 24 hours. See [Message Exchange for Social Care and Health (MESH) API -
  NHS England Digital](https://digital.nhs.uk/developer/api-catalogue/message-exchange-for-social-care-and-health-api#post-/messageexchange/-mailbox_id-)

- **DPSExport** - Sends vaccination records to DPS for processing via MESH. Runs
  nightly and generates a DPS export for each campaign that has unsent records.

## Additional resources

- [Message Exchange for Social Care and Health (MESH) API - NHS England Digital](https://digital.nhs.uk/developer/api-catalogue/message-exchange-for-social-care-and-health-api#overview--end-to-end-process-to-integrate-with-mesh-api)
- [Apply for a MESH mailbox - NHS England Digital](https://digital.nhs.uk/services/message-exchange-for-social-care-and-health-mesh/messaging-exchange-for-social-care-and-health-apply-for-a-mailbox) - part of the application form for the MESH mailbox touches on creating a request for a TLS cert
- [Message Exchange for Social Care and Health: certificate guidance - NHS England Digital](https://digital.nhs.uk/services/message-exchange-for-social-care-and-health-mesh/mesh-guidance-hub/certificate-guidance) - more detailed instructions that targets Windows systems, but still useful
